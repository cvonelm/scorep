## -*- mode: makefile -*-

## 
## This file is part of the Score-P software (http://www.score-p.org)
##
## Copyright (c) 2009-2012, 
##    RWTH Aachen, Germany
##    Gesellschaft fuer numerische Simulation mbH Braunschweig, Germany
##    Technische Universitaet Dresden, Germany
##    University of Oregon, Eugene, USA
##    Forschungszentrum Juelich GmbH, Germany
##    German Research School for Simulation Sciences GmbH, Juelich/Aachen, Germany
##    Technische Universitaet Muenchen, Germany
##
## See the COPYING file in the package base directory for details.
##

## file       test/installcheck/Makefile.common.in
## maintainer Christian Roessel <c.roessel@fz-juelich.de>

all:

#------------------------------------------------------------------------------
# Common settings
#------------------------------------------------------------------------------

BINDIR          = @abs_top_builddir@/../installcheck/bin
INCDIR          = @abs_top_builddir@/../installcheck/$(PARADIGM)
PARADIGM_SRCDIR = @abs_top_srcdir@/../test/installcheck/$(PARADIGM)/src
PREPS_FILE      = @abs_top_builddir@/../installcheck/configurations_$(PARADIGM)
EXE             = $(BINDIR)/$(CODE)-$(PARADIGM)-$(LANG)$(SUFFIX)

#------------------------------------------------------------------------------
# Instrument possible configurations: copy sources from SRC_ORIG to
# src and call Makefiles in src/<code>/<language> to instrument codes
# based on the make arguments PREP, SUFFIX, OBJDIR, BINDIR, and
# CODE. The possible PREP arguments come from the PREPS_FILE. The
# triggered Makefiles include this Makefile.common to use the rules
# below. Instrumented apps can be found in BINDIR.
#------------------------------------------------------------------------------

instrument-configurations: $(PREPS_FILE) $(PARADIGM_SRCDIR) $(BINDIR)
	@for code in $(CODES); do \
            for language in $(LANGUAGES); do \
                suffix="_default"; \
                obj_dir="`pwd`/build/$$code/$$language/$$suffix"; \
                mkdir -p "$$obj_dir"; \
                cp $(PARADIGM_SRCDIR)/$$code/$$language/Makefile "$$obj_dir"/; \
                echo "  GEN    ../installcheck/bin/$${code}-$(PARADIGM)-$${language}$${suffix}"; \
                $(MAKE) -C $$obj_dir \
                    PREP="@prefix@/bin/scorep" \
                    SUFFIX=$$suffix \
                    OBJDIR="$$obj_dir" \
                    BINDIR=$(BINDIR) \
                    CODE=$$code \
                    LANG=$$language \
                    SRCDIR=$(PARADIGM_SRCDIR)/$$code/$$language \
                    INCDIR=$(INCDIR) \
                    $$code || exit 1; \
                while read line; do \
                    prep=`echo $$line | awk '{for (i=1; i<= NF; i++) {options = options " --" $$i} } END{print "@prefix@/bin/scorep" options}'`; \
                    suffix=`echo $$line | awk '{for (i=1; i<= NF; i++) {suffix = suffix "_" $$i} } END{print suffix}'`; \
                    obj_dir="`pwd`/build/$$code/$$language/$$suffix"; \
                    mkdir -p "$$obj_dir"; \
                    cp $(PARADIGM_SRCDIR)/$$code/$$language/Makefile "$$obj_dir"/; \
                    echo "  GEN    ../installcheck/bin/$${code}-$(PARADIGM)-$${language}$${suffix}"; \
                    $(MAKE) -C $$obj_dir \
                        PREP="$$prep" \
                        SUFFIX=$$suffix \
                        OBJDIR="$$obj_dir" \
                        BINDIR=$(BINDIR) \
                        CODE=$$code \
                        LANG=$$language \
                        SRCDIR=$(PARADIGM_SRCDIR)/$$code/$$language \
                        INCDIR=$(INCDIR) \
                        $$code || exit 1; \
                done < $(PREPS_FILE); \
            done; \
        done

$(BINDIR):
	mkdir -p $(BINDIR)

$(PREPS_FILE):
	$(MAKE) -C @abs_top_builddir@ instrumenter-configurations

#------------------------------------------------------------------------------
# Common rules to instrument codes
#------------------------------------------------------------------------------

all:

$(CODE): $(EXE)

$(BINDIR)/$(CODE)-$(PARADIGM)-cc$(SUFFIX): $(OBJECTS)
	$(PREP) $(CC) $(CFLAGS) -o $@ $(OBJECTS) $(LIBS)

$(BINDIR)/$(CODE)-$(PARADIGM)-cxx$(SUFFIX): $(OBJECTS)
	$(PREP) $(CXX) $(CXXFLAGS) -o $@ $(OBJECTS) $(LIBS)

$(BINDIR)/$(CODE)-$(PARADIGM)-f77$(SUFFIX): $(OBJECTS)
	$(PREP) $(F77) $(F77FLAGS) -o $@ $(OBJECTS) $(LIBS)

$(BINDIR)/$(CODE)-$(PARADIGM)-fc$(SUFFIX): $(OBJECTS)
	$(PREP) $(FC) $(FCFLAGS) -o $@ $(OBJECTS) $(LIBS)

$(OBJDIR)/%.o: $(SRCDIR)/%.c
	$(PREP) $(CC) $(CFLAGS) -o $@ -c $< 

$(OBJDIR)/%.o: $(SRCDIR)/%.cpp
	$(PREP) $(CXX) $(CXXFLAGS) -o $@ -c $<

$(OBJDIR)/%.o: $(SRCDIR)/%.f77
	$(PREP) $(F77) $(F77FLAGS) -o $@ -c $<

$(OBJDIR)/%.o: $(SRCDIR)/%.f90
	$(PREP) $(FC) $(FCFLAGS) -o $@ -c $<

$(OBJDIR)/%.o: $(SRCDIR)/%.F90
	$(PREP) $(FC) $(FCFLAGS) -o $@ -c $<

clean:
	rm -f $(EXE) $(OBJECTS)

.PHONY: $(CODE) clean

