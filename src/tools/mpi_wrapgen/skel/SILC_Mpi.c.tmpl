/****************************************************************************
**  SCALASCA    http://www.scalasca.org/                                   **
**  KOJAK       http://www.fz-juelich.de/jsc/kojak/                        **
*****************************************************************************
**  Copyright (c) 1998-2009                                                **
**  Forschungszentrum Juelich, Juelich Supercomputing Centre               **
**                                                                         **
**  Copyright (c) 2003-2008                                                **
**  University of Tennessee, Innovative Computing Laboratory               **
**                                                                         **
**  See the file COPYRIGHT in the package base directory for details       **
****************************************************************************/

/**
 * @file  SILC_Mpi.c
 * @brief Main file for C interface measurement wrappers
 */

#include "epk_mpicom.h"
#include "SILC_Mpiwrap_Reg.h"

#include "elg_error.h"

#include "esd_def.h"
#include "esd_event.h"
#include "esd_run.h"

#include <stdio.h>
#include <stdlib.h>
#include <mpi.h>

/** internal array of statuses */
static MPI_Status* my_status_array = 0;
/** size of internal status array */
static int         my_status_array_size = 0;

/**
 * Get a pointer to a status array of at least 'size' statuses
 * @param  size minimal requested size
 * @return pointer to status array
 * @ingroup util
 */
static MPI_Status* epk_get_status_array(int size) {
  if (my_status_array_size == 0)
  {
    /* -- never used: initialize -- */
    my_status_array = malloc(size * sizeof(MPI_Status));
    if (my_status_array == NULL) elg_error();
    my_status_array_size = size;
  } 
  else if (size > my_status_array_size)
  {
    /* -- not enough room: expand -- */
    my_status_array = realloc(my_status_array, size * sizeof(MPI_Status));
    if (my_status_array == NULL) elg_error();
    my_status_array_size = size;
  }
  return my_status_array;
}

/** flag to indicate whether event generation is turned on or off */
int epk_mpi_nogen = 0;

/** check whether event generation is turned on */
#define IS_EVENT_GEN_ON            (!epk_mpi_nogen)
/** check whether event generation is turned on for a specific group */
#define IS_EVENT_GEN_ON_FOR(group) ((!epk_mpi_nogen) && (epk_mpi_enabled & EPK_MPI_ENABLED_##group))
/** turn off event generation */
#define EVENT_GEN_OFF()            epk_mpi_nogen = 1
/** turn on event generation */
#define EVENT_GEN_ON()             epk_mpi_nogen = 0

/*
 *-----------------------------------------------------------------------------
 *
 * name Environmental Management
 *
 *-----------------------------------------------------------------------------
 */

#include "SILC_Mpi_Env.c"

/*
 *-----------------------------------------------------------------------------
 *
 * External interfaces
 * 
 *-----------------------------------------------------------------------------
 */

#include "SILC_Mpi_Ext.c"

/*
 *-----------------------------------------------------------------------------
 *
 * Datatypes
 * 
 *-----------------------------------------------------------------------------
 */

#include "SILC_Mpi_Type.c"

/*
 *-----------------------------------------------------------------------------
 *
 * Miscelaneous
 * 
 *-----------------------------------------------------------------------------
 */

#include "SILC_Mpi_Misc.c"

/*
 *-----------------------------------------------------------------------------
 *
 * Communicator management
 *
 *-----------------------------------------------------------------------------
 */

#include "SILC_Mpi_Cg.c"

/* 
 *-----------------------------------------------------------------------------
 *
 * Cartesian Toplogy functions
 *
 *-----------------------------------------------------------------------------
 */

#include "SILC_Mpi_Topo.c"

/*
 *-----------------------------------------------------------------------------
 *
 * Point-to-point communication
 *
 *-----------------------------------------------------------------------------
 */

#include "SILC_Mpi_P2p.c"

/*
 *-----------------------------------------------------------------------------
 *
 * Collective communication
 *
 *-----------------------------------------------------------------------------
 */

#include "SILC_Mpi_Coll.c"

/*
 *-----------------------------------------------------------------------------
 *
 * One-sided Communication
 *
 *-----------------------------------------------------------------------------
 */

#ifdef HAS_MPI2_1SIDED
#include "SILC_Mpi_Rma.c"
#endif

/*
 *-----------------------------------------------------------------------------
 *
 * Parallel I/O
 *
 *-----------------------------------------------------------------------------
 */
#ifdef HAS_MPI2_IO
#include "SILC_Mpi_Io.c"
#endif

/*
 *-----------------------------------------------------------------------------
 *
 * Process Creation and Management
 *
 *-----------------------------------------------------------------------------
 */

#ifdef HAS_MPI2_SPAWN
#include "SILC_Mpi_Spawn.c"
#endif

/*
 *-----------------------------------------------------------------------------
 *
 * Error Handlers
 *
 *-----------------------------------------------------------------------------
 */

#include "SILC_Mpi_Err.c"
